---
- name: Bootstrap passwordless sudo for Ansible user (workaround for sudo-rs)
  hosts: all
  gather_facts: no
  become: no
  pre_tasks:
    - name: Prefer static IP for this run if it is reachable (avoid DNS/duplicate A records)
      ansible.builtin.wait_for:
        host: "{{ static_ip }}"
        port: 22
        timeout: 2
        state: started
      delegate_to: localhost
      become: no
      register: static_ssh_ready
      failed_when: false
      changed_when: false
      when: static_ip is defined and (static_ip | trim) != ''

    - name: Switch ansible_host to static IP when reachable
      ansible.builtin.set_fact:
        ansible_host: "{{ static_ip }}"
      when:
        - static_ip is defined and (static_ip | trim) != ''
        - static_ssh_ready is defined
        - static_ssh_ready.failed is not defined or static_ssh_ready.failed == false

    - name: Reset connection after switching ansible_host
      meta: reset_connection
      when:
        - static_ip is defined and (static_ip | trim) != ''
        - static_ssh_ready is defined
        - static_ssh_ready.failed is not defined or static_ssh_ready.failed == false
  tasks:
    - name: Check if sudoers drop-in already exists
      ansible.builtin.raw: "test -f /etc/sudoers.d/99-ansible-nopasswd && echo present || echo missing"
      register: sudoers_dropin_check
      changed_when: false
      failed_when: false

    - name: Set fact for sudoers presence
      ansible.builtin.set_fact:
        sudoers_dropin_exists: "{{ (sudoers_dropin_check.stdout | default('') | trim) == 'present' }}"

    - name: Prompt for sudo password if needed
      ansible.builtin.pause:
        prompt: "Passwordless sudo not configured on {{ inventory_hostname }}. Enter sudo password"
        echo: no
      register: sudo_password_prompt
      when: not sudoers_dropin_exists

    - name: Create sudoers drop-in for passwordless sudo
      ansible.builtin.shell: |
        echo '{{ sudo_password_prompt.user_input }}' | sudo -S bash -c 'echo "{{ ansible_user | default('thomasschissler') }} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/99-ansible-nopasswd && chmod 0440 /etc/sudoers.d/99-ansible-nopasswd'
      args:
        executable: /bin/bash
      register: sudoers_write
      changed_when: true
      no_log: true
      when: not sudoers_dropin_exists

    - name: Verify passwordless sudo works (bounded)
      ansible.builtin.raw: "command -v timeout >/dev/null 2>&1 && timeout 3 sudo -n id -u || sudo -n id -u"
      register: sudo_test
      changed_when: false
      failed_when: false

    - name: Assert passwordless sudo is working
      ansible.builtin.assert:
        that:
          - sudo_test is defined
          - sudo_test.rc == 0
          - (sudo_test.stdout | default('') | trim) == '0'
        fail_msg: "Passwordless sudo verification failed on {{ inventory_hostname }}"
        success_msg: "Passwordless sudo is {{ 'now configured' if (not sudoers_dropin_exists) else 'already configured' }} for {{ ansible_user | default('thomasschissler') }}"
