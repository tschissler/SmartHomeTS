---
- name: Bootstrap passwordless sudo for Ansible user (workaround for sudo-rs)
  hosts: all
  gather_facts: no
  become: no
  tasks:
    - name: Check if passwordless sudo already works
      ansible.builtin.shell: sudo -n id -u
      register: sudo_check
      changed_when: false
      failed_when: false

    - name: Prompt for sudo password if needed
      ansible.builtin.pause:
        prompt: "Passwordless sudo not configured on {{ inventory_hostname }}. Enter sudo password"
        echo: no
      register: sudo_password_prompt
      when: sudo_check.rc != 0

    - name: Create sudoers drop-in for passwordless sudo
      ansible.builtin.shell: |
        echo '{{ sudo_password_prompt.user_input }}' | sudo -S bash -c 'echo "{{ ansible_user | default('thomasschissler') }} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/99-ansible-nopasswd && chmod 0440 /etc/sudoers.d/99-ansible-nopasswd'
      args:
        executable: /bin/bash
      register: sudoers_write
      changed_when: true
      no_log: true
      when: sudo_check.rc != 0

    - name: Verify passwordless sudo works
      ansible.builtin.shell: sudo -n id -u
      register: sudo_test
      changed_when: false

    - name: Assert passwordless sudo is working
      ansible.builtin.assert:
        that:
          - sudo_test.rc == 0
          - sudo_test.stdout | trim == '0'
        fail_msg: "Passwordless sudo verification failed on {{ inventory_hostname }}"
        success_msg: "Passwordless sudo is {{ 'now configured' if (sudo_check.rc != 0) else 'already configured' }} for {{ ansible_user | default('thomasschissler') }}"
