---
- name: Configure AdGuard DNS rewrites (intern hostnames)
  hosts: k3s_servers
  become: yes
  gather_facts: no
  vars:
    adguard_namespace: adguard-home
    adguard_api_service_url: "http://adguard-web.adguard-home.svc.cluster.local:3000"
    adguard_api_username: ""
    adguard_api_password: ""
    ingress_vip: "{{ kubevip_service_range_start }}"
    adguard_rewrite_entries:
      - domain: "{{ paperless_consume_domain | default('paperless-consume.intern') }}"
        answer: "{{ paperless_consume_ip | default('') }}"
      - domain: "{{ nextcloud_domain | default('nextcloud.intern') }}"
        answer: "{{ ingress_vip }}"
  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - (paperless_consume_ip | default('')) | trim != ''
          - ingress_vip is defined
          - ingress_vip | trim != ''
        fail_msg: "paperless_consume_ip and kubevip_service_range_start must be set"
      run_once: true

  tasks:
    - name: Read current AdGuard rewrites (JSON)
      ansible.builtin.shell: |
        set -e
        NS={{ adguard_namespace }}
        URL={{ adguard_api_service_url }}

        AUTH_ARGS=""
        if [ -n "{{ adguard_api_username | default('') }}" ] && [ -n "{{ adguard_api_password | default('') }}" ]; then
          AUTH_ARGS="-u {{ adguard_api_username }}:{{ adguard_api_password }}"
        fi

        /usr/local/bin/k3s kubectl -n "$NS" get svc adguard-web >/dev/null

        /usr/local/bin/k3s kubectl -n "$NS" run adguard-rewrite-lister \
          --image=curlimages/curl:8.6.0 \
          --restart=Never \
          --rm \
          -i \
          --command -- sh -lc \
          "curl -sS $AUTH_ARGS '$URL/control/rewrite/list'" 2>/dev/null || echo "[]"
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      register: adguard_rewrite_list
      changed_when: false

    - name: Debug raw API response
      ansible.builtin.debug:
        var: adguard_rewrite_list.stdout
      run_once: true

    - name: Parse current AdGuard rewrites
      ansible.builtin.set_fact:
        adguard_rewrites_current: "{{ (adguard_rewrite_list.stdout | trim | split('\n') | first | from_json) if (adguard_rewrite_list.stdout | trim | length > 0) else [] }}"
      run_once: true

    - name: Add missing AdGuard rewrites via API
      ansible.builtin.shell: |
        set -e
        NS={{ adguard_namespace }}
        URL={{ adguard_api_service_url }}

        AUTH_ARGS=""
        if [ -n "{{ adguard_api_username | default('') }}" ] && [ -n "{{ adguard_api_password | default('') }}" ]; then
          AUTH_ARGS="-u {{ adguard_api_username }}:{{ adguard_api_password }}"
        fi

        domain={{ item.domain | quote }}
        answer={{ item.answer | quote }}
        payload=$(printf '{"domain":"%s","answer":"%s"}' "$domain" "$answer")
        pod_name="adguard-rewrite-add-$(date +%s%N | md5sum | cut -c1-8)"

        /usr/local/bin/k3s kubectl -n "$NS" run "$pod_name" \
          --image=curlimages/curl:8.6.0 \
          --restart=Never \
          --rm \
          -i \
          --command -- sh -lc \
          "curl -sS $AUTH_ARGS -H 'Content-Type: application/json' -X POST -d '$payload' '$URL/control/rewrite/add'"
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      loop: "{{ adguard_rewrite_entries }}"
      when: >-
        (adguard_rewrites_current | default([])
          | selectattr('domain','equalto', item.domain)
          | list
          | length) == 0
      register: adguard_rewrite_add
      changed_when: true

    - name: Update AdGuard rewrites when IP changed (delete old + add new)
      ansible.builtin.shell: |
        set -e
        NS={{ adguard_namespace }}
        URL={{ adguard_api_service_url }}

        AUTH_ARGS=""
        if [ -n "{{ adguard_api_username | default('') }}" ] && [ -n "{{ adguard_api_password | default('') }}" ]; then
          AUTH_ARGS="-u {{ adguard_api_username }}:{{ adguard_api_password }}"
        fi

        domain={{ item.domain | quote }}
        old_answer={{ (
          (adguard_rewrites_current | default([])
            | selectattr('domain','equalto', item.domain)
            | map(attribute='answer')
            | list
          ) | first | default('')
        ) | quote }}
        new_answer={{ item.answer | quote }}

        old_payload=$(printf '{"domain":"%s","answer":"%s"}' "$domain" "$old_answer")
        old_payload_domain_only=$(printf '{"domain":"%s"}' "$domain")
        new_payload=$(printf '{"domain":"%s","answer":"%s"}' "$domain" "$new_answer")

        pod_del="adguard-rewrite-del-$(date +%s%N | md5sum | cut -c1-8)"
        pod_add="adguard-rewrite-add-$(date +%s%N | md5sum | cut -c1-8)"

        # Try delete with domain+answer, then fall back to domain-only
        /usr/local/bin/k3s kubectl -n "$NS" run "$pod_del" \
          --image=curlimages/curl:8.6.0 \
          --restart=Never \
          --rm \
          -i \
          --command -- sh -lc \
          "curl -sS $AUTH_ARGS -H 'Content-Type: application/json' -X POST -d '$old_payload' '$URL/control/rewrite/delete' >/dev/null" \
          || /usr/local/bin/k3s kubectl -n "$NS" run "${pod_del}2" \
            --image=curlimages/curl:8.6.0 \
            --restart=Never \
            --rm \
            -i \
            --command -- sh -lc \
            "curl -sS $AUTH_ARGS -H 'Content-Type: application/json' -X POST -d '$old_payload_domain_only' '$URL/control/rewrite/delete' >/dev/null"

        # Add new
        /usr/local/bin/k3s kubectl -n "$NS" run "$pod_add" \
          --image=curlimages/curl:8.6.0 \
          --restart=Never \
          --rm \
          -i \
          --command -- sh -lc \
          "curl -sS $AUTH_ARGS -H 'Content-Type: application/json' -X POST -d '$new_payload' '$URL/control/rewrite/add' >/dev/null"
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      loop: "{{ adguard_rewrite_entries }}"
      when: >-
        (adguard_rewrites_current | default([])
          | selectattr('domain','equalto', item.domain)
          | list
          | length) > 0
        and (
          (
            (adguard_rewrites_current | default([])
              | selectattr('domain','equalto', item.domain)
              | map(attribute='answer')
              | list
            ) | first | default('')
          ) != (item.answer | default(''))
        )
      changed_when: true

    - name: Info
      ansible.builtin.debug:
        msg: |
          If this did not add the rewrite, AdGuard may require auth.
          Re-run with: -e adguard_api_username=... -e adguard_api_password=...
      run_once: true
