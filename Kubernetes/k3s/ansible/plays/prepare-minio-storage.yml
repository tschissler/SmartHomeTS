---
- name: Prepare MinIO storage directories on k3snode1 & k3snode2
  hosts: k3snode1,k3snode2
  become: yes
  gather_facts: yes
  vars:
    longhorn_mount: /var/lib/longhorn-data
    minio_base: "{{ longhorn_mount }}/minio-data"
    minio_data_size_gb: 100  # Allocate 100GB for MinIO initially
    
  pre_tasks:
    - name: Abort if not running on k3snode1 or k3snode2
      ansible.builtin.assert:
        that:
          - inventory_hostname in ['k3snode1', 'k3snode2']
        fail_msg: "This playbook only runs on k3snode1 and k3snode2 (storage nodes)"
        
  tasks:
    - name: Check if Longhorn storage is mounted
      ansible.builtin.command: mountpoint -q {{ longhorn_mount }}
      changed_when: false
      failed_when: false
      register: longhorn_mounted
      
    - name: GATE - Abort if Longhorn storage not ready
      ansible.builtin.assert:
        that:
          - longhorn_mounted.rc == 0
        fail_msg: |
          ABORT: Longhorn storage not mounted at {{ longhorn_mount }}
          
          Run prepare-longhorn-storage.yml first:
          ansible-playbook plays/prepare-longhorn-storage.yml -i inventory.ini
          
    - name: Get available space on Longhorn partition
      ansible.builtin.shell: df -BG {{ longhorn_mount }} | awk 'NR==2 {print $4}' | sed 's/G//'
      register: available_space
      changed_when: false
      
    - name: Display current status
      ansible.builtin.debug:
        msg: |
          ========================================================
          MinIO Storage Preparation - {{ inventory_hostname }}
          ========================================================
          Longhorn Mount:          {{ longhorn_mount }}
          MinIO Base Directory:    {{ minio_base }}
          Available Space:         {{ available_space.stdout }}G
          Planned Allocation:      {{ minio_data_size_gb }}G
          
          Node-specific paths:
          - {{ minio_base }}
          ========================================================
          
    - name: GATE - Verify sufficient space for MinIO
      ansible.builtin.assert:
        that:
          - available_space.stdout | int >= minio_data_size_gb
        fail_msg: |
          ABORT: Insufficient space on {{ longhorn_mount }}
          Available: {{ available_space.stdout }}G, Required: {{ minio_data_size_gb }}G
          
    - name: Create MinIO data directory
      ansible.builtin.file:
        path: "{{ minio_base }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
        
    - name: Display final status
      ansible.builtin.debug:
        msg: |
          ========================================================
          âœ“ MinIO Storage Ready - {{ inventory_hostname }}
          ========================================================
          Base Directory:   {{ minio_base }}
          
          Verify with:
          ls -la {{ minio_base }}
          df -h {{ longhorn_mount }}
          
          Next Steps:
          1. Deploy MinIO via ArgoCD
          2. MinIO will auto-initialize
          3. InfluxDB bucket and credentials created automatically
          ========================================================
