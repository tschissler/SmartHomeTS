---
- name: Install Longhorn storage system
  hosts: k3s_servers
  become: yes
  gather_facts: no
  vars:
    longhorn_namespace: longhorn-system
    longhorn_chart_version: "{{ longhorn_helm_version | default('1.10.1') }}"
    longhorn_data_path: /var/lib/longhorn-data
    longhorn_replica_count: "{{ longhorn_default_replica_count | default(2) }}"
    longhorn_node_down_pod_deletion_policy: "{{ longhorn_node_down_pod_deletion_policy | default('delete-both-statefulset-and-deployment-pod') }}"
    # Optional: Pin Longhorn system-managed components (manager, CSI plugin, engine-image, etc.)
    # to specific nodes using a Kubernetes label selector.
    # Example (matches your existing labels): "node.longhorn.io/create-default-disk=true"
    # WARNING: If you pin these components away from a node, pods on that node may no longer
    # be able to mount Longhorn volumes.
    longhorn_system_managed_components_node_selector: "{{ longhorn_system_managed_components_node_selector | default('') }}"
  pre_tasks:
    - name: Check if helm is installed
      ansible.builtin.command: /usr/local/bin/k3s kubectl version --client
      register: helm_check
      changed_when: false
      failed_when: false
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"

  tasks:
    - name: Add Longhorn Helm repository
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml create namespace {{ longhorn_namespace }} --dry-run=client -o yaml | /usr/local/bin/k3s kubectl apply -f -
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        helm repo add longhorn https://charts.longhorn.io
        helm repo update
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Create Longhorn values ConfigMap
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl apply -f - <<EOF
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: longhorn-values
          namespace: {{ longhorn_namespace }}
        data:
          values.yaml: |
            defaultSettings:
              defaultDataPath: {{ longhorn_data_path }}
              createDefaultDiskLabeledNodes: true
              defaultReplicaCount: {{ longhorn_replica_count }}
              replicaSoftAntiAffinity: false
              nodeDownPodDeletionPolicy: {{ longhorn_node_down_pod_deletion_policy }}
              taintToleration: "node-role.kubernetes.io/master:NoSchedule;node-role.kubernetes.io/control-plane:NoSchedule"
            persistence:
              defaultClass: true
              defaultClassReplicaCount: {{ longhorn_replica_count }}
            ingress:
              enabled: false
        EOF
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Install Longhorn via Helm
      ansible.builtin.shell: |
        helm upgrade --install longhorn longhorn/longhorn \
          --namespace {{ longhorn_namespace }} \
          --create-namespace \
          --version {{ longhorn_chart_version }} \
          --set defaultSettings.defaultDataPath={{ longhorn_data_path }} \
          --set defaultSettings.createDefaultDiskLabeledNodes=true \
          --set defaultSettings.defaultReplicaCount={{ longhorn_replica_count }} \
          --set defaultSettings.replicaSoftAntiAffinity=false \
          --set defaultSettings.nodeDownPodDeletionPolicy={{ longhorn_node_down_pod_deletion_policy }} \
          --set defaultSettings.taintToleration="node-role.kubernetes.io/master:NoSchedule;node-role.kubernetes.io/control-plane:NoSchedule" \
          --set persistence.defaultClass=true \
          --set persistence.defaultClassReplicaCount={{ longhorn_replica_count }} \
          --set ingress.enabled=false
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Wait for Longhorn deployment to be ready
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ longhorn_namespace }} rollout status deployment/longhorn-driver-deployer --timeout=300s
        /usr/local/bin/k3s kubectl -n {{ longhorn_namespace }} rollout status daemonset/longhorn-manager --timeout=300s
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false
      retries: 5
      delay: 10
      register: longhorn_rollout
      until: longhorn_rollout.rc == 0

    - name: Optionally pin Longhorn system-managed components to selected nodes
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ longhorn_namespace }} patch settings.longhorn.io system-managed-components-node-selector \
          --type merge \
          -p '{"value":"{{ longhorn_system_managed_components_node_selector }}"}'
      when:
        - longhorn_system_managed_components_node_selector is defined
        - longhorn_system_managed_components_node_selector | trim != ''
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Compute Longhorn storage/non-storage node lists from inventory
      ansible.builtin.set_fact:
        longhorn_storage_nodes: "{{ groups.get('longhorn_storage_nodes', []) }}"
        longhorn_all_cluster_nodes: "{{ (groups.get('k3s_servers', []) + groups.get('k3s_agents', [])) | unique }}"
      run_once: true

    - name: Annotate Longhorn storage nodes with disk configuration
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl annotate node {{ item }} \
          node.longhorn.io/default-disks-config='[{"path":"{{ longhorn_data_path }}","allowScheduling":true}]' \
          --overwrite
      loop: "{{ longhorn_storage_nodes }}"
      when: longhorn_storage_nodes | length > 0
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Label Longhorn storage nodes for default disk creation
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl label node {{ item }} \
          node.longhorn.io/create-default-disk=true \
          --overwrite
      loop: "{{ longhorn_storage_nodes }}"
      when: longhorn_storage_nodes | length > 0
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Label non-storage nodes to prevent default disk creation
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl label node {{ item }} \
          node.longhorn.io/create-default-disk=false \
          --overwrite
      loop: "{{ longhorn_all_cluster_nodes | difference(longhorn_storage_nodes) }}"
      when:
        - longhorn_all_cluster_nodes | length > 0
        - (longhorn_all_cluster_nodes | difference(longhorn_storage_nodes)) | length > 0
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Display Longhorn installation status
      ansible.builtin.debug:
        msg: |
          ========================================================
          Longhorn Installation Complete
          ========================================================
          Namespace:        {{ longhorn_namespace }}
          Data Path:        {{ longhorn_data_path }}
          Replica Count:    {{ longhorn_replica_count }}
          
          Check Status:
          kubectl -n {{ longhorn_namespace }} get pods
          kubectl get storageclass
          
          Longhorn wird jetzt als default StorageClass verwendet.
          Neue PVCs nutzen automatisch Longhorn f√ºr replizierte Speicherung.
          
          Optional: Longhorn UI via Port-Forward:
          kubectl port-forward -n {{ longhorn_namespace }} svc/longhorn-frontend 8080:80
          Dann erreichbar: http://localhost:8080
          ========================================================
      run_once: true
      delegate_to: localhost
      become: false
