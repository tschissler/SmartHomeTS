---
- name: Ensure Traefik Service exposes MQTT TCP port for Mosquitto
  hosts: k3s_servers
  become: yes
  gather_facts: no
  vars:
    mqtt_vip: "{{ kubevip_service_range_start }}"
  pre_tasks:
    - name: Validate MQTT VIP is set
      ansible.builtin.assert:
        that:
          - mqtt_vip is defined
          - mqtt_vip | trim != ''
        fail_msg: "kubevip_service_range_start must be set (used as MQTT VIP)"
      run_once: true

  tasks:
    # The MQTT entrypoint and port are configured in configure-ingress-hostnames.yml
    # via the consolidated HelmChartConfig. This playbook only ensures the
    # Traefik Service object exposes the MQTT port.

    - name: Wait for Traefik deployment to be ready
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n kube-system rollout status deployment traefik --timeout=120s
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Patch Traefik Service to expose MQTT port
      ansible.builtin.shell: |
        if ! /usr/local/bin/k3s kubectl -n kube-system get svc traefik -o jsonpath='{.spec.ports[?(@.name=="mqtt")].port}' | grep -q 1883; then
          /usr/local/bin/k3s kubectl -n kube-system get svc traefik -o yaml > /tmp/traefik-svc.yaml
          sed -i '/^  selector:/i\  - name: mqtt\n    port: 1883\n    protocol: TCP\n    targetPort: mqtt' /tmp/traefik-svc.yaml
          /usr/local/bin/k3s kubectl apply -f /tmp/traefik-svc.yaml
          rm /tmp/traefik-svc.yaml
        fi
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Wait for Traefik Service to be reconfigured with MQTT port
      ansible.builtin.shell: |
        for i in $(seq 1 60); do
          /usr/local/bin/k3s kubectl -n kube-system get svc traefik -o jsonpath='{.spec.ports[?(@.name=="mqtt")].port}' 2>/dev/null | grep -q 1883 && exit 0
          sleep 2
        done
        echo "Timed out waiting for Traefik MQTT port" >&2
        exit 1
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Display MQTT access info
      ansible.builtin.debug:
        msg: |
          Traefik MQTT entrypoint configured
          Connect to MQTT at: {{ mqtt_vip }}:1883
          Hostname: mosquitto.intern (add to DNS or /etc/hosts pointing to {{ mqtt_vip }})
      run_once: true
