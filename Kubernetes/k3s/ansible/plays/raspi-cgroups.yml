---
- name: Prepare Raspberry Pi for k3s (disable swap + enable cgroups)
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    cgroup_flags: "cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory"
    cmdline_path: /boot/firmware/cmdline.txt
  tasks:
    - name: Skip if not ARM architecture
      ansible.builtin.meta: end_host
      when: ansible_facts.architecture not in ['aarch64', 'arm64', 'armv7l', 'armv6l']

    # Disable swap
    - name: Check if dphys-swapfile exists
      ansible.builtin.stat:
        path: /etc/dphys-swapfile
      register: dphys_swapfile_stat

    - name: Disable swap in dphys-swapfile
      ansible.builtin.lineinfile:
        path: /etc/dphys-swapfile
        regexp: '^CONF_SWAPSIZE='
        line: 'CONF_SWAPSIZE=0'
        state: present
      register: swap_disabled
      when: dphys_swapfile_stat.stat.exists

    - name: Stop and disable dphys-swapfile service
      ansible.builtin.systemd:
        name: dphys-swapfile
        state: stopped
        enabled: no
      when: dphys_swapfile_stat.stat.exists
      failed_when: false

    - name: Turn off all swap immediately
      ansible.builtin.command: swapoff -a
      changed_when: false
      failed_when: false

    # Enable cgroups
    - name: Check if cmdline.txt exists
      ansible.builtin.stat:
        path: "{{ cmdline_path }}"
      register: cmdline_stat

    - name: Read current cmdline.txt
      ansible.builtin.slurp:
        path: "{{ cmdline_path }}"
      register: cmdline_file
      when: cmdline_stat.stat.exists

    - name: Check if cgroup flags are already present
      ansible.builtin.set_fact:
        cgroup_already_present: >-
          {{
            (cmdline_file.content | b64decode) is search('cgroup_enable=cpuset')
            and (cmdline_file.content | b64decode) is search('cgroup_memory=1')
            and (cmdline_file.content | b64decode) is search('cgroup_enable=memory')
          }}
      when: cmdline_stat.stat.exists

    - name: Append cgroup flags to cmdline.txt if not present
      ansible.builtin.lineinfile:
        path: "{{ cmdline_path }}"
        regexp: '^(.*)$'
        line: '\1 {{ cgroup_flags }}'
        backrefs: yes
      register: cmdline_updated
      when: cmdline_stat.stat.exists and not cgroup_already_present

    - name: Reboot if configuration changed
      ansible.builtin.reboot:
        reboot_timeout: 600
      when: >
        (swap_disabled is defined and swap_disabled.changed)
        or
        (cmdline_updated is defined and cmdline_updated.changed)

    # Verify after reboot
    - name: Verify swap is disabled
      ansible.builtin.command: swapon --show
      register: swap_check
      changed_when: false
      failed_when: false

    - name: Assert swap is disabled
      ansible.builtin.assert:
        that: swap_check.stdout == ''
        fail_msg: "Swap is still enabled on {{ inventory_hostname }}"
        success_msg: "Swap is disabled"

    - name: Verify cgroup flags in /proc/cmdline
      ansible.builtin.command: cat /proc/cmdline
      register: proc_cmdline
      changed_when: false

    - name: Assert cgroup flags are present
      ansible.builtin.assert:
        that:
          - proc_cmdline.stdout is search('cgroup_enable=cpuset')
          - proc_cmdline.stdout is search('cgroup_memory=1')
          - proc_cmdline.stdout is search('cgroup_enable=memory')
        fail_msg: >-
          Cgroup flags not found in /proc/cmdline on {{ inventory_hostname }}.
          Expected: {{ cgroup_flags }}
          Actual: {{ proc_cmdline.stdout }}
        success_msg: "Cgroup flags are present in kernel cmdline"
