---
- name: Deploy AdGuard Home DNS server
  hosts: k3s_servers
  become: yes
  gather_facts: no
  vars:
    adguard_namespace: adguard-home
    adguard_storage_size: 1Gi
    adguard_lb_ip: "{{ adguard_home_lb_ip | default('') }}"
    adguard_upstream_dns: "{{ adguard_home_upstream_dns | default('192.168.178.1') }}"
    adguard_longhorn_domain: "{{ adguard_home_longhorn_domain | default('longhorn.intern') }}"
    adguard_ui_domain: "{{ adguard_home_ui_domain | default('adguard.intern') }}"
    adguard_argocd_domain: "{{ adguard_home_argocd_domain | default('argocd.intern') }}"
  pre_tasks:
    - name: Validate AdGuard Home LoadBalancer IP is set
      ansible.builtin.assert:
        that:
          - adguard_lb_ip is defined
          - adguard_lb_ip | trim != ''
        fail_msg: "adguard_home_lb_ip must be set in group_vars or via -e adguard_home_lb_ip=..."
      run_once: true

    - name: Ensure AdGuard LB IP is in kube-vip service range
      ansible.builtin.assert:
        that:
          - adguard_lb_ip | regex_search('^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$')
        fail_msg: "adguard_home_lb_ip={{ adguard_lb_ip }} is not a valid IP address"
      run_once: true

    - name: Initialize AdGuard rewrite list with core entries
      ansible.builtin.set_fact:
        adguard_rewrite_list:
          - domain: "{{ adguard_longhorn_domain }}"
            answer: "{{ adguard_lb_ip }}"
          - domain: "{{ adguard_ui_domain }}"
            answer: "{{ adguard_lb_ip }}"
          - domain: "{{ adguard_argocd_domain }}"
            answer: "{{ adguard_lb_ip }}"
          - domain: "mosquitto.intern"
            answer: "{{ kubevip_service_range_start }}"
      run_once: true

    - name: Append node hostnames to AdGuard rewrites
      ansible.builtin.set_fact:
        adguard_rewrite_list: >-
          {{ adguard_rewrite_list + [
              {'domain': item ~ '.intern', 'answer': hostvars[item].static_ip},
              {'domain': item, 'answer': hostvars[item].static_ip}
            ] }}
      loop: "{{ groups['prodservers'] }}"
      run_once: true

  tasks:
    - name: Create AdGuard Home namespace
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl create namespace {{ adguard_namespace }} --dry-run=client -o yaml | /usr/local/bin/k3s kubectl apply -f -
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Scale down AdGuard Home Deployment (avoid PVC multi-attach during update)
      ansible.builtin.shell: |
        if /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} get deployment adguard-home >/dev/null 2>&1; then
          /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} scale deployment adguard-home --replicas=0
        fi
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Wait until AdGuard Home pods are terminated
      ansible.builtin.shell: |
        for i in $(seq 1 90); do
          if ! /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} get pods -l app=adguard-home --no-headers 2>/dev/null | grep -q .; then
            exit 0
          fi
          sleep 2
        done
        echo "Timed out waiting for AdGuard Home pods to terminate" >&2
        /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} get pods -l app=adguard-home -o wide || true
        exit 1
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Create AdGuard Home PersistentVolumeClaim
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl apply -f - <<EOF
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: adguard-data
          namespace: {{ adguard_namespace }}
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: longhorn
          resources:
            requests:
              storage: {{ adguard_storage_size }}
        EOF
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Render AdGuard Home config from template
      ansible.builtin.template:
        src: ../templates/adguard-config.yaml.j2
        dest: /tmp/adguard-config.yaml
        mode: '0644'
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"

    - name: Create AdGuard Home ConfigMap from rendered config
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} create configmap adguard-config \
          --from-file=AdGuardHome.yaml=/tmp/adguard-config.yaml \
          --dry-run=client -o yaml | /usr/local/bin/k3s kubectl apply -f -
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Deploy AdGuard Home Deployment
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: adguard-home
          namespace: {{ adguard_namespace }}
          labels:
            app: adguard-home
        spec:
          replicas: 1
          strategy:
            type: Recreate
          selector:
            matchLabels:
              app: adguard-home
          template:
            metadata:
              labels:
                app: adguard-home
            spec:
              initContainers:
              # Copy config from ConfigMap to writable PVC (AdGuard needs to modify config)
              - name: init-config
                image: busybox:1.36
                command: ['sh', '-c', 'mkdir -p /mnt/adguard/conf /mnt/adguard/work && if [ ! -f /mnt/adguard/conf/AdGuardHome.yaml ]; then cp /config-template/AdGuardHome.yaml /mnt/adguard/conf/AdGuardHome.yaml; fi']
                volumeMounts:
                - name: adguard-storage
                  mountPath: /mnt/adguard
                - name: adguard-config-template
                  mountPath: /config-template
              containers:
              - name: adguard-home
                image: adguard/adguardhome:latest
                ports:
                - containerPort: 53
                  name: dns-tcp
                  protocol: TCP
                - containerPort: 53
                  name: dns-udp
                  protocol: UDP
                - containerPort: 3000
                  name: http
                  protocol: TCP
                volumeMounts:
                - name: adguard-storage
                  mountPath: /opt/adguardhome/work
                  subPath: work
                - name: adguard-storage
                  mountPath: /opt/adguardhome/conf
                  subPath: conf
                resources:
                  requests:
                    cpu: 100m
                    memory: 128Mi
                  limits:
                    cpu: 500m
                    memory: 512Mi
              volumes:
              - name: adguard-storage
                persistentVolumeClaim:
                  claimName: adguard-data
              - name: adguard-config-template
                configMap:
                  name: adguard-config
        EOF
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Create AdGuard Home DNS Service (LoadBalancer)
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: adguard-dns
          namespace: {{ adguard_namespace }}
          annotations:
            kube-vip.io/loadbalancerIPs: "{{ adguard_lb_ip }}"
        spec:
          type: LoadBalancer
          loadBalancerIP: "{{ adguard_lb_ip }}"
          selector:
            app: adguard-home
          ports:
          - name: dns-tcp
            port: 53
            targetPort: 53
            protocol: TCP
          - name: dns-udp
            port: 53
            targetPort: 53
            protocol: UDP
        EOF
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Create AdGuard Home Web UI Service (LoadBalancer)
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: adguard-web
          namespace: {{ adguard_namespace }}
          annotations:
            kube-vip.io/loadbalancerIPs: "{{ adguard_lb_ip }}"
        spec:
          type: LoadBalancer
          loadBalancerIP: "{{ adguard_lb_ip }}"
          selector:
            app: adguard-home
          ports:
          - name: http
            port: 3000
            targetPort: 3000
            protocol: TCP
        EOF
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false

    - name: Restart AdGuard Home to apply config changes
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} rollout restart deployment/adguard-home
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false
      failed_when: false

    - name: Wait for AdGuard Home deployment to be ready
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} rollout status deployment/adguard-home --timeout=180s
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false
      retries: 5
      delay: 10
      register: adguard_rollout
      until: adguard_rollout.rc == 0

    - name: Display AdGuard Home access information
      ansible.builtin.debug:
        msg: |
          ========================================================
          AdGuard Home Installation Complete
          ========================================================
          Web UI:       http://{{ adguard_lb_ip }}:3000
          DNS Server:   {{ adguard_lb_ip }}:53
          Upstream DNS: {{ adguard_upstream_dns }} (FritzBox)
          
          VIP-Architektur:
          - 192.168.178.222 → Cluster API (kubectl, k3s intern)
          - {{ adguard_lb_ip }} → Shared Service VIP (DNS, später Ingress etc.)
                        AdGuard nutzt Ports 53 + 3000
                        Weitere Services teilen sich diese IP auf anderen Ports
          
          Next Steps:
          1. Open http://{{ adguard_lb_ip }}:3000 in your browser
          2. Complete the initial setup wizard
          3. Test DNS: nslookup google.de {{ adguard_lb_ip }}
          
          Migration Strategy (no ESP32 restart needed):
          ---------------------------------------------
          Phase 1 (Current): All devices use FritzBox DNS ({{ adguard_upstream_dns }})
          Phase 2 (Testing): Test einzelne Geräte manuell auf {{ adguard_lb_ip }}
          Phase 3 (Rollout): FritzBox DHCP → DNS Server auf {{ adguard_lb_ip }} ändern
                             (Geräte migrieren schrittweise bei DHCP-Renewal)
          
          FritzBox DHCP Einstellung:
          - Melde dich an: http://192.168.178.1
          - Heimnetz → Netzwerk → Netzwerkeinstellungen
          - IPv4-Adressen → "Lokaler DNS-Server" → {{ adguard_lb_ip }}
          - Speichern (neue DHCP-Leases nutzen dann AdGuard)
          
          Bestehende ESP32-Sensoren arbeiten weiter mit {{ adguard_upstream_dns }}
          bis zur nächsten DHCP-Renewal (typisch 24h) oder manueller Neustart.
          ========================================================
      run_once: true
      delegate_to: localhost
      become: false

    - name: Reduce Longhorn auto-detach timeout
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n longhorn-system patch setting detachtimeout --type merge -p '{"value":"30"}' || true
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false
