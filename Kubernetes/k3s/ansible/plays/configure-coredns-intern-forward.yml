---
- name: Configure CoreDNS to resolve .intern via AdGuard
  hosts: k3s_servers
  become: yes
  gather_facts: no
  vars:
    coredns_namespace: kube-system
    coredns_custom_configmap: coredns-custom
    adguard_namespace: adguard-home
    adguard_dns_service: adguard-dns
    intern_zone: intern
    fritzbox_dns_ip: 192.168.178.1

  tasks:
    - name: Read AdGuard DNS ClusterIP (preferred for in-cluster resolution)
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ adguard_namespace }} get svc {{ adguard_dns_service }} -o jsonpath='{.spec.clusterIP}'
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false
      register: adguard_dns_clusterip
      failed_when: adguard_dns_clusterip.stdout | trim == ''

    - name: Render CoreDNS intern zone config
      ansible.builtin.template:
        src: ../templates/coredns-intern-forward.yaml.j2
        dest: /tmp/coredns-intern-zone.yaml
        mode: '0644'
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"

    - name: Apply CoreDNS custom server block(s)
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ coredns_namespace }} apply -f /tmp/coredns-intern-zone.yaml
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      register: coredns_custom_cm_apply
      changed_when: coredns_custom_cm_apply.stdout is defined and ("configured" in coredns_custom_cm_apply.stdout or "created" in coredns_custom_cm_apply.stdout)

    - name: Restart CoreDNS to pick up custom config
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ coredns_namespace }} rollout restart deployment/coredns
        /usr/local/bin/k3s kubectl -n {{ coredns_namespace }} rollout status deployment/coredns --timeout=180s
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      when: coredns_custom_cm_apply is defined and coredns_custom_cm_apply.changed

    - name: Test DNS resolution from an in-cluster pod (via kube-dns)
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n default run dns-intern-test --image=busybox:1.36 --restart=Never --rm -it \
          --command -- sh -lc 'cat /etc/resolv.conf; echo; nslookup argocd.{{ intern_zone | default('"'"'intern'"'"') }}; nslookup longhorn.{{ intern_zone | default('"'"'intern'"'"') }}'
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      changed_when: false
