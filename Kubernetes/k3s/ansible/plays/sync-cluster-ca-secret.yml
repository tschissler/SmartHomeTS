---
- name: Sync cluster-ca-secret from cert-manager to application namespaces
  hosts: k3s_servers
  become: yes
  gather_facts: no
  vars:
    source_namespace: cert-manager
    source_secret: cluster-ca-secret
    # List of namespaces that need the CA certificate
    target_namespaces:
      - nextcloud
      - collabora

  tasks:
    - name: Verify source secret exists
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl get secret {{ source_secret }} -n {{ source_namespace }} -o name
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      register: source_secret_check
      failed_when: source_secret_check.rc != 0
      changed_when: false

    - name: Display source secret information
      ansible.builtin.debug:
        msg: "Found source secret: {{ source_secret_check.stdout }}"
      run_once: true

    - name: Copy cluster-ca-secret to target namespaces
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl get secret {{ source_secret }} \
          -n {{ source_namespace }} \
          -o yaml | \
        sed 's/namespace: {{ source_namespace }}/namespace: {{ item }}/g' | \
        /usr/local/bin/k3s kubectl apply -n {{ item }} -f -
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      loop: "{{ target_namespaces }}"
      register: secret_copy_result
      changed_when: "'created' in secret_copy_result.stdout or 'configured' in secret_copy_result.stdout"

    - name: Display copy results
      ansible.builtin.debug:
        msg: "Synced {{ source_secret }} to {{ item }}: {{ secret_copy_result.results[index].stdout }}"
      loop: "{{ target_namespaces }}"
      loop_control:
        index_var: index
      run_once: true

    - name: Verify secrets were synced successfully
      ansible.builtin.shell: |
        for ns in {{ target_namespaces | join(' ') }}; do
          echo "Checking $ns namespace..."
          /usr/local/bin/k3s kubectl get secret {{ source_secret }} -n $ns -o name && echo "✓ Secret exists in $ns" || echo "✗ Secret MISSING in $ns"
        done
      run_once: true
      delegate_to: "{{ (groups.get('k3s_servers', []) | first) }}"
      register: verification
      changed_when: false

    - name: Display verification results
      ansible.builtin.debug:
        msg: "{{ verification.stdout_lines }}"
      run_once: true
