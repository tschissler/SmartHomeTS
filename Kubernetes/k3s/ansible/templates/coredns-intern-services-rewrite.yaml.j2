---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-custom
  namespace: kube-system
data:
  # Rewrite rules for .intern domain services to resolve to internal Kubernetes service DNS names
  # This allows pods in the cluster to reach external .intern services via their internal service DNS names
  {% for service_name, service_dns in intern_service_rewrites.items() %}
  {{ service_name }}-intern.server: |
    {{ service_name }}.intern:53 {
        errors
        cache 30
        rewrite name exact {{ service_name }}.intern {{ service_dns }}
        forward . 10.43.0.10
        reload 5s
    }
  {% endfor %}

  # Existing service definitions (preserved)
  envoym1.server: |
    envoym1:53 {
        errors
        cache 30
        rewrite name exact envoym1 envoym1.fritz.box
        forward . 192.168.178.1
        reload 5s
    }

  envoym3.server: |
    envoym3:53 {
        errors
        cache 30
        rewrite name exact envoym3 envoym3.fritz.box
        forward . 192.168.178.1
        reload 5s
    }

  fritz.box.server: |
    fritz.box:53 {
        errors
        cache 30
        forward . 192.168.178.1
        reload 5s
    }

  intern.server: |
    intern:53 {
        errors
        cache 30
        forward . 10.43.11.255
        reload 5s
    }

