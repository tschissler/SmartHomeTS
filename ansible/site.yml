---
# Rebuilds the k3s cluster to the current working state:
# - HA API VIP via kube-vip
# - Traefik LB on a dedicated VIP
# - Longhorn with prepared nodes + default disks
# - Nextcloud + Collabora
# - CoreDNS NodeHosts for *.local
# - Traefik encoded-path keeper for Collabora WebSockets

- name: Base OS prerequisites
  hosts: all
  become: true
  roles:
    - common

- name: Install k3s (initial server)
  hosts: k3s_init
  become: true
  roles:
    - k3s_init

- name: Fetch k3s join token
  hosts: k3s_init
  become: true
  tasks:
    - name: Read server node-token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_node_token_file
      no_log: true

    - name: Expose join token for other plays
      ansible.builtin.set_fact:
        k3s_join_token: "{{ (k3s_node_token_file.content | b64decode) | trim }}"
      no_log: true

- name: Install k3s (additional servers)
  hosts: k3s_servers:!k3s_init
  become: true
  vars:
    k3s_join_token: "{{ hostvars[groups['k3s_init'][0]].k3s_join_token }}"
  roles:
    - k3s_server_join

- name: Configure kubectl for user on server nodes (optional)
  hosts: k3s_servers
  become: true
  roles:
    - kubectl_userconfig

- name: Install k3s (agents)
  hosts: k3s_agents
  become: true
  vars:
    k3s_join_token: "{{ hostvars[groups['k3s_init'][0]].k3s_join_token }}"
  roles:
    - k3s_agent

- name: Bootstrap kube-vip (API VIP + service LB range)
  hosts: k3s_init
  become: true
  roles:
    - kube_vip

- name: Label nodes (architecture + storage)
  hosts: k3s_init
  become: true
  roles:
    - node_labels

- name: Prepare Longhorn dependencies (node side)
  hosts: k3s_servers
  become: true
  roles:
    - longhorn_node_prep

- name: Prepare Longhorn dedicated disk (optional)
  hosts: storage_nodes
  become: true
  roles:
    - longhorn_disk

- name: Install Traefik / Longhorn / Apps (cluster side)
  hosts: k3s_init
  become: true
  roles:
    - traefik
    - longhorn
    - coredns_nodehosts
    - traefik_encodedchars_keeper
    - nextcloud

- name: Postflight checks
  hosts: k3s_init
  become: true
  roles:
    - postflight
