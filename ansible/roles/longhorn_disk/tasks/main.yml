---
# Prepares a dedicated block device/partition for Longhorn at {{ longhorn_data_path }}.
# Safety: does nothing unless longhorn_manage_disk=true and longhorn_disk_device_by_host contains a device for this host.

- name: Resolve Longhorn disk device for this host
  ansible.builtin.set_fact:
    longhorn_disk_device: "{{ longhorn_disk_device_by_host[inventory_hostname] | default('') }}"

- name: Skip if disk management is disabled
  ansible.builtin.meta: end_host
  when: not (longhorn_manage_disk | default(false) | bool)

- name: Fail if no device configured for this host
  ansible.builtin.fail:
    msg: >-
      longhorn_manage_disk=true but no longhorn_disk_device_by_host entry for {{ inventory_hostname }}.
      Set e.g. longhorn_disk_device_by_host: { clusternode1: /dev/sdb, clusternode2: /dev/sdb }
  when: longhorn_disk_device | length == 0

- name: Ensure required packages for disk prep are installed
  ansible.builtin.apt:
    name:
      - parted
      - util-linux
      - e2fsprogs
    state: present
    update_cache: true

- name: Determine whether the configured path is a whole disk or a partition
  ansible.builtin.command: "lsblk -no TYPE {{ longhorn_disk_device }}"
  register: longhorn_lsblk_type
  changed_when: false
  failed_when: false

- name: Set partition path
  ansible.builtin.set_fact:
    longhorn_disk_is_partition: "{{ (longhorn_lsblk_type.stdout | trim) == 'part' }}"
    longhorn_disk_partition: >-
      {{ longhorn_disk_device if ((longhorn_lsblk_type.stdout | trim) == 'part')
         else (longhorn_disk_device + ('p1' if (longhorn_disk_device is search('nvme')) else '1')) }}

- name: Check if partition table exists
  ansible.builtin.command: "lsblk -no PTTYPE {{ longhorn_disk_device }}"
  register: pttype
  changed_when: false
  failed_when: false

- name: Create GPT partition table when missing
  ansible.builtin.command: "parted -s {{ longhorn_disk_device }} mklabel gpt"
  when:
    - not longhorn_disk_is_partition
    - (pttype.stdout | trim) == ""

- name: Check if partition already exists
  ansible.builtin.stat:
    path: "{{ longhorn_disk_partition }}"
  register: part_stat

- name: Create a single primary partition (100%)
  ansible.builtin.command: "parted -s {{ longhorn_disk_device }} mkpart primary 0% 100%"
  when:
    - not longhorn_disk_is_partition
    - not part_stat.stat.exists

- name: Probe filesystem type
  ansible.builtin.command: "blkid -o value -s TYPE {{ longhorn_disk_partition }}"
  register: fs_probe
  changed_when: false
  failed_when: false

- name: Fail if filesystem exists but is not desired type
  ansible.builtin.fail:
    msg: "{{ longhorn_disk_partition }} already has filesystem '{{ fs_probe.stdout | trim }}' but expected '{{ longhorn_fs_type }}'. Refusing to overwrite."
  when:
    - (fs_probe.rc == 0)
    - (fs_probe.stdout | trim) != ""
    - (fs_probe.stdout | trim) != (longhorn_fs_type | default('ext4'))

- name: Create filesystem if missing
  ansible.builtin.command: "mkfs.{{ longhorn_fs_type }} -F {{ longhorn_disk_partition }}"
  when: (fs_probe.rc != 0) or ((fs_probe.stdout | trim) == "")

- name: Ensure mount point exists
  ansible.builtin.file:
    path: "{{ longhorn_data_path }}"
    state: directory
    mode: '0755'

- name: Read partition UUID
  ansible.builtin.command: "blkid -o value -s UUID {{ longhorn_disk_partition }}"
  register: part_uuid
  changed_when: false

- name: Mount Longhorn disk by UUID
  ansible.posix.mount:
    path: "{{ longhorn_data_path }}"
    src: "UUID={{ part_uuid.stdout | trim }}"
    fstype: "{{ longhorn_fs_type }}"
    opts: "{{ longhorn_mount_opts }}"
    state: mounted
