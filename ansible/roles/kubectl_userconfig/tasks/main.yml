---
# Optional convenience: make plain `kubectl` work for a normal user on k3s *server* nodes.
# - Ensures kubectl symlink exists (k3s usually installs this)
# - Copies /etc/rancher/k3s/k3s.yaml to ~/.kube/config with correct permissions
# - Adds KUBECONFIG export to ~/.bashrc

- name: Skip if not enabled
  ansible.builtin.meta: end_host
  when: not (setup_kubectl_for_user | default(false) | bool)

- name: Ensure kubectl symlink exists (if missing)
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link
  when: kubectl_symlink_to_k3s | default(true) | bool

- name: Resolve target user
  ansible.builtin.set_fact:
    kubeconfig_user: "{{ kubeconfig_user | default(ansible_user) }}"

- name: Get passwd entry for target user
  ansible.builtin.getent:
    database: passwd
    key: "{{ kubeconfig_user }}"

- name: Set kubeconfig home
  ansible.builtin.set_fact:
    kubeconfig_home: "{{ getent_passwd[kubeconfig_user][4] }}"

- name: Ensure ~/.kube exists
  ansible.builtin.file:
    path: "{{ kubeconfig_home }}/.kube"
    state: directory
    owner: "{{ kubeconfig_user }}"
    group: "{{ kubeconfig_user }}"
    mode: '0700'

- name: Copy k3s kubeconfig to user kubeconfig
  ansible.builtin.copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ kubeconfig_home }}/.kube/config"
    remote_src: true
    owner: "{{ kubeconfig_user }}"
    group: "{{ kubeconfig_user }}"
    mode: '0600'

- name: Ensure KUBECONFIG export exists in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ kubeconfig_home }}/.bashrc"
    line: 'export KUBECONFIG=$HOME/.kube/config'
    create: true
    insertafter: EOF
    state: present
    owner: "{{ kubeconfig_user }}"
    group: "{{ kubeconfig_user }}"
    mode: '0644'
