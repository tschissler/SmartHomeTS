---
- name: Ensure helm is installed
  ansible.builtin.shell: |
    set -euo pipefail
    if command -v helm >/dev/null 2>&1; then
      exit 0
    fi
    apt-get update
    apt-get install -y helm
  args:
    executable: /bin/bash

- name: Ensure nextcloud namespace exists
  ansible.builtin.shell: |
    set -euo pipefail
    /usr/local/bin/k3s kubectl create namespace {{ nextcloud_namespace }} --dry-run=client -o yaml | /usr/local/bin/k3s kubectl apply -f -
  args:
    executable: /bin/bash
  changed_when: false

- name: Render Nextcloud values
  ansible.builtin.template:
    src: nextcloud-values.yaml.j2
    dest: /tmp/nextcloud-values.yaml
    mode: '0644'

- name: Render Collabora values
  ansible.builtin.template:
    src: collabora-values.yaml.j2
    dest: /tmp/collabora-values.yaml
    mode: '0600'
  no_log: true

- name: Add Nextcloud helm repo
  ansible.builtin.command: helm repo add nextcloud https://nextcloud.github.io/helm/
  register: nextcloud_repo
  changed_when: "'has been added' in nextcloud_repo.stdout or 'already exists' not in nextcloud_repo.stdout"
  failed_when: false

- name: Add Collabora helm repo
  ansible.builtin.command: helm repo add collabora https://collaboraonline.github.io/online/
  register: collabora_repo
  changed_when: "'has been added' in collabora_repo.stdout or 'already exists' not in collabora_repo.stdout"
  failed_when: false

- name: Helm repo update
  ansible.builtin.command: helm repo update
  changed_when: false

- name: Install/upgrade Nextcloud
  ansible.builtin.command: >-
    helm upgrade --install nextcloud nextcloud/nextcloud
    --namespace {{ nextcloud_namespace }}
    --version {{ nextcloud_chart_version }}
    -f /tmp/nextcloud-values.yaml
  changed_when: true

- name: Install/upgrade Collabora
  ansible.builtin.command: >-
    helm upgrade --install collabora collabora/collabora-online
    --namespace {{ nextcloud_namespace }}
    --version {{ collabora_chart_version }}
    -f /tmp/collabora-values.yaml
  changed_when: true

- name: Wait for Nextcloud deployment
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n {{ nextcloud_namespace }} rollout status deploy/nextcloud --timeout=600s
  changed_when: false
  failed_when: false

- name: Wait for Collabora deployment
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n {{ nextcloud_namespace }} rollout status deploy/collabora-collabora-online --timeout=600s
  changed_when: false
  failed_when: false

- name: Enable richdocuments app (idempotent)
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n {{ nextcloud_namespace }} exec deploy/nextcloud -- php occ app:enable richdocuments
  register: richdocs_enable
  changed_when: "'enabled' in (richdocs_enable.stdout | lower)"
  failed_when: false

- name: Configure richdocuments WOPI URLs
  ansible.builtin.command: >-
    /usr/local/bin/k3s kubectl -n {{ nextcloud_namespace }} exec deploy/nextcloud --
    php occ config:app:set richdocuments {{ item.key }} --value={{ item.value | quote }}
  loop:
    - { key: 'wopi_url', value: 'http://collabora-collabora-online:9980' }
    - { key: 'wopi_public_url', value: 'http://{{ office_hostname }}' }
  changed_when: true
  failed_when: false
