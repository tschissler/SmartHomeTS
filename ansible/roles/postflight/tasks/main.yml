---
# Postflight checks to confirm the cluster is functional after the playbook finished.
# Runs on k3s_init (server node).

- name: Skip postflight if disabled
  ansible.builtin.meta: end_host
  when: not (postflight_enabled | default(true) | bool)

- name: Show cluster nodes
  ansible.builtin.command: /usr/local/bin/k3s kubectl get nodes -o wide
  changed_when: false

- name: Verify all nodes are Ready
  ansible.builtin.shell: |
    set -euo pipefail
    /usr/local/bin/k3s kubectl get nodes -o json | jq -e '
      .items
      | map({name: .metadata.name, ready: ([.status.conditions[] | select(.type=="Ready")][0].status)})
      | (map(select(.ready != "True")) | length) == 0
    ' >/dev/null
  args:
    executable: /bin/bash
  changed_when: false

- name: Wait for CoreDNS
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n kube-system rollout status deploy/coredns --timeout={{ postflight_rollout_timeout | default('240s') }}
  changed_when: false

- name: Wait for Traefik DaemonSet
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n {{ traefik_namespace }} rollout status ds/traefik --timeout={{ postflight_rollout_timeout | default('300s') }}
  changed_when: false

- name: Wait for Longhorn UI
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n {{ longhorn_namespace }} rollout status deploy/longhorn-ui --timeout={{ postflight_rollout_timeout | default('420s') }}
  changed_when: false
  failed_when: false

- name: Wait for Nextcloud
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n {{ nextcloud_namespace }} rollout status deploy/nextcloud --timeout={{ postflight_rollout_timeout | default('900s') }}
  changed_when: false
  failed_when: false

- name: Wait for Collabora
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n {{ nextcloud_namespace }} rollout status deploy/collabora-collabora-online --timeout={{ postflight_rollout_timeout | default('900s') }}
  changed_when: false
  failed_when: false

- name: Check Traefik service has expected LB IP
  ansible.builtin.shell: |
    set -euo pipefail
    ip=$(/usr/local/bin/k3s kubectl -n {{ traefik_namespace }} get svc traefik -o json | jq -r '.status.loadBalancer.ingress[0].ip // empty')
    test -n "$ip"
    test "$ip" = "{{ traefik_lb_ip }}"
  args:
    executable: /bin/bash
  changed_when: false

- name: Verify CoreDNS NodeHosts contains expected hostnames
  ansible.builtin.shell: |
    set -euo pipefail
    nodehosts=$(/usr/local/bin/k3s kubectl -n kube-system get configmap coredns -o json | jq -r '.data.NodeHosts')
    echo "$nodehosts" | grep -Fq "{{ nextcloud_hostname }}"
    echo "$nodehosts" | grep -Fq "{{ office_hostname }}"
    echo "$nodehosts" | grep -Fq "{{ longhorn_hostname }}"
  args:
    executable: /bin/bash
  changed_when: false

- name: Verify Traefik has encoded-path flags for Collabora
  ansible.builtin.shell: |
    set -euo pipefail
    args=$(/usr/local/bin/k3s kubectl -n {{ traefik_namespace }} get ds traefik -o json | jq -r '.spec.template.spec.containers[0].args[]')
    echo "$args" | grep -Fq "--entryPoints.web.http.encodedcharacters.allowencodedslash=true"
    echo "$args" | grep -Fq "--entryPoints.web.http.encodedcharacters.allowencodedquestionmark=true"
    echo "$args" | grep -Fq "--entryPoints.web.http.sanitizepath=false"
    echo "$args" | grep -Fq "--entryPoints.websecure.http.encodedcharacters.allowencodedslash=true"
    echo "$args" | grep -Fq "--entryPoints.websecure.http.encodedcharacters.allowencodedquestionmark=true"
    echo "$args" | grep -Fq "--entryPoints.websecure.http.sanitizepath=false"
  args:
    executable: /bin/bash
  changed_when: false

- name: HTTP check Nextcloud via Traefik (Host header on LB IP)
  ansible.builtin.shell: |
    set -euo pipefail
    code=$(curl -sS -o /dev/null -w "%{http_code}" -H "Host: {{ nextcloud_hostname }}" http://{{ traefik_lb_ip }}/)
    case "$code" in
      200|301|302|303|307|308) exit 0;;
      *) echo "Unexpected HTTP code: $code"; exit 1;;
    esac
  args:
    executable: /bin/bash
  changed_when: false

- name: HTTP check Collabora discovery via Traefik
  ansible.builtin.shell: |
    set -euo pipefail
    code=$(curl -sS -o /dev/null -w "%{http_code}" -H "Host: {{ office_hostname }}" http://{{ traefik_lb_ip }}/hosting/discovery)
    case "$code" in
      200|301|302|303|307|308) exit 0;;
      *) echo "Unexpected HTTP code: $code"; exit 1;;
    esac
  args:
    executable: /bin/bash
  changed_when: false
