apiVersion: v1
kind: Namespace
metadata:
  name: kube-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-encodedchars-keeper
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: traefik-encodedchars-keeper
  namespace: kube-system
rules:
  - apiGroups: ["apps"]
    resources: ["daemonsets"]
    resourceNames: ["traefik"]
    verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: traefik-encodedchars-keeper
  namespace: kube-system
subjects:
  - kind: ServiceAccount
    name: traefik-encodedchars-keeper
    namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: traefik-encodedchars-keeper
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: traefik-encodedchars-patch
  namespace: kube-system
data:
  patch.json: |-
    [
      {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--entryPoints.web.http.encodedcharacters.allowencodedslash=true"},
      {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--entryPoints.web.http.encodedcharacters.allowencodedquestionmark=true"},
      {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--entryPoints.web.http.sanitizepath=false"},
      {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--entryPoints.websecure.http.encodedcharacters.allowencodedslash=true"},
      {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--entryPoints.websecure.http.encodedcharacters.allowencodedquestionmark=true"},
      {"op": "add", "path": "/spec/template/spec/containers/0/args/-", "value": "--entryPoints.websecure.http.sanitizepath=false"}
    ]
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: traefik-encodedchars-keeper
  namespace: kube-system
spec:
  schedule: "*/15 * * * *"
  startingDeadlineSeconds: 300
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      ttlSecondsAfterFinished: 600
      template:
        spec:
          serviceAccountName: traefik-encodedchars-keeper
          restartPolicy: OnFailure
          tolerations:
            - key: "node-role.kubernetes.io/master"
              operator: "Exists"
              effect: "NoSchedule"
            - key: "node-role.kubernetes.io/control-plane"
              operator: "Exists"
              effect: "NoSchedule"
          containers:
            - name: kubectl
              image: rancher/local-path-provisioner:v0.0.32
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -lc
                - |
                  set -eu

                  K3S_BIN=/host/usr/local/bin/k3s
                  if [ ! -x "$K3S_BIN" ]; then
                    echo "ERROR: $K3S_BIN not found/executable. Ensure k3s is installed at /usr/local/bin/k3s on this node."
                    exit 1
                  fi

                  TOKEN_FILE=/var/run/secrets/kubernetes.io/serviceaccount/token
                  CA_FILE=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                  SERVER=https://kubernetes.default.svc
                  TOKEN="$(cat "$TOKEN_FILE")"

                  KUBECTL="$K3S_BIN kubectl --server=$SERVER --certificate-authority=$CA_FILE --token=$TOKEN"

                  args="$($KUBECTL -n kube-system get ds traefik -o jsonpath='{.spec.template.spec.containers[0].args}')"

                  if echo "$args" | grep -q 'allowencodedslash=true'; then
                    echo "Traefik already patched (encoded slashes allowed)."
                    exit 0
                  fi

                  echo "Patching Traefik DaemonSet for Collabora WebSockets (encoded path chars)..."
                  $KUBECTL -n kube-system patch ds traefik --type=json --patch-file /patch/patch.json
              volumeMounts:
                - name: patch
                  mountPath: /patch
                  readOnly: true
                - name: host-k3s
                  mountPath: /host/usr/local/bin
                  readOnly: true
                - name: host-k3s-state
                  mountPath: /var/lib/rancher/k3s
          volumes:
            - name: patch
              configMap:
                name: traefik-encodedchars-patch
            - name: host-k3s
              hostPath:
                path: /usr/local/bin
                type: Directory
            - name: host-k3s-state
              hostPath:
                path: /var/lib/rancher/k3s
                type: Directory
