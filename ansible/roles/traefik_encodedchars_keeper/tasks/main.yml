---
- name: Copy Traefik encoded-chars keeper manifest
  ansible.builtin.copy:
    src: traefik-encodedchars-keeper.yaml
    dest: /tmp/traefik-encodedchars-keeper.yaml
    mode: '0644'
- name: Apply keeper CronJob + RBAC
  ansible.builtin.command: /usr/local/bin/k3s kubectl apply -f /tmp/traefik-encodedchars-keeper.yaml
  changed_when: true

- name: Trigger keeper once (patch immediately)
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n kube-system create job --from=cronjob/traefik-encodedchars-keeper traefik-encodedchars-keeper-now
  register: keeper_job
  changed_when: true
  failed_when: false

- name: Wait for keeper job completion
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n kube-system wait --for=condition=complete job/traefik-encodedchars-keeper-now --timeout=120s
  changed_when: false
  failed_when: false

- name: Cleanup keeper job
  ansible.builtin.command: /usr/local/bin/k3s kubectl -n kube-system delete job traefik-encodedchars-keeper-now --ignore-not-found
  changed_when: false
  failed_when: false
