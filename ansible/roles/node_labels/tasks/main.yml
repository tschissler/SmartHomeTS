---

- name: Get node architectures from the cluster
  ansible.builtin.shell: |
    set -euo pipefail
    /usr/local/bin/k3s kubectl get nodes -o json |
      jq -r '.items[] | "\(.metadata.name)\t\(.status.nodeInfo.architecture)"'
  args:
    executable: /bin/bash
  register: node_arch_lines
  changed_when: false

- name: Label nodes with capability/architecture
  ansible.builtin.command: >-
    /usr/local/bin/k3s kubectl label node {{ item.split('\t')[0] }}
    capability/architecture={{ 'x86' if (item.split('\t')[1] | lower) in ['x86_64','amd64'] else 'arm64' }}
    --overwrite
  loop: "{{ node_arch_lines.stdout_lines | default([]) }}"
  changed_when: false
  failed_when: false

- name: Label storage nodes
  ansible.builtin.command: >-
    /usr/local/bin/k3s kubectl label node {{ item }} node-role.kubernetes.io/storage=true --overwrite
  loop: "{{ groups['storage_nodes'] | default([]) }}"
  changed_when: false
  failed_when: false
